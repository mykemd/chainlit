"use strict";function e(e,t){if(t==null||t>e.length)t=e.length;for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function t(e){if(Array.isArray(e))return e}function n(t){if(Array.isArray(t))return e(t)}function r(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function a(e,t,n,r,a,o,s){try{var i=e[o](s);var u=i.value}catch(e){n(e);return}if(i.done){t(u)}else{Promise.resolve(u).then(r,a)}}function o(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var s=e.apply(t,n);function i(e){a(s,r,o,i,u,"next",e)}function u(e){a(s,r,o,i,u,"throw",e)}i(undefined)})}}function s(e,t,n){t=h(t);return _(e,T()?Reflect.construct(t,n||[],h(e).constructor):t.apply(e,n))}function i(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function u(e,t,n){if(T()){u=Reflect.construct}else{u=function e(e,t,n){var r=[null];r.push.apply(r,t);var a=Function.bind.apply(e,r);var o=new a;if(n)C(o,n.prototype);return o}}return u.apply(null,arguments)}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}function l(e,t,n){if(t)c(e.prototype,t);if(n)c(e,n);return e}function f(e,t,n){if(t in e){Object.defineProperty(e,t,{value:n,enumerable:true,configurable:true,writable:true})}else{e[t]=n}return e}function d(){d=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n){if(Object.prototype.hasOwnProperty.call(n,r)){e[r]=n[r]}}}return e};return d.apply(this,arguments)}function h(e){h=Object.setPrototypeOf?Object.getPrototypeOf:function e(e){return e.__proto__||Object.getPrototypeOf(e)};return h(e)}function p(e,t){if(typeof t!=="function"&&t!==null){throw new TypeError("Super expression must either be null or a function")}e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:true,configurable:true}});if(t)C(e,t)}function v(e,t){if(t!=null&&typeof Symbol!=="undefined"&&t[Symbol.hasInstance]){return!!t[Symbol.hasInstance](e)}else{return e instanceof t}}function g(e){return Function.toString.call(e).indexOf("[native code]")!==-1}function y(e){if(typeof Symbol!=="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function m(e,t){var n=e==null?null:typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(n==null)return;var r=[];var a=true;var o=false;var s,i;try{for(n=n.call(e);!(a=(s=n.next()).done);a=true){r.push(s.value);if(t&&r.length===t)break}}catch(e){o=true;i=e}finally{try{if(!a&&n["return"]!=null)n["return"]()}finally{if(o)throw i}}return r}function k(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function w(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function b(e){if(e===null||e===void 0)throw new TypeError("Cannot destructure "+e);return e}function S(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};var r=Object.keys(n);if(typeof Object.getOwnPropertySymbols==="function"){r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))}r.forEach(function(t){f(e,t,n[t])})}return e}function A(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);if(t){r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})}n.push.apply(n,r)}return n}function R(e,t){t=t!=null?t:{};if(Object.getOwnPropertyDescriptors){Object.defineProperties(e,Object.getOwnPropertyDescriptors(t))}else{A(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}function _(e,t){if(t&&(I(t)==="object"||typeof t==="function")){return t}return r(e)}function C(e,t){C=Object.setPrototypeOf||function e(e,t){e.__proto__=t;return e};return C(e,t)}function x(e,n){return t(e)||m(e,n)||P(e,n)||k()}function E(e){return n(e)||y(e)||P(e)||w()}function I(e){"@swc/helpers - typeof";return e&&typeof Symbol!=="undefined"&&e.constructor===Symbol?"symbol":typeof e}function P(t,n){if(!t)return;if(typeof t==="string")return e(t,n);var r=Object.prototype.toString.call(t).slice(8,-1);if(r==="Object"&&t.constructor)r=t.constructor.name;if(r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return e(t,n)}function D(e){var t=typeof Map==="function"?new Map:undefined;D=function e(e){if(e===null||!g(e))return e;if(typeof e!=="function"){throw new TypeError("Super expression must either be null or a function")}if(typeof t!=="undefined"){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return u(e,arguments,h(this).constructor)}n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:false,writable:true,configurable:true}});return C(n,e)};return D(e)}function T(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(T=function(){return!!e})()}function M(e,t){var n,r,a,o,s={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]};return o={next:i(0),"throw":i(1),"return":i(2)},typeof Symbol==="function"&&(o[Symbol.iterator]=function(){return this}),o;function i(e){return function(t){return u([e,t])}}function u(o){if(n)throw new TypeError("Generator is already executing.");while(s)try{if(n=1,r&&(a=o[0]&2?r["return"]:o[0]?r["throw"]||((a=r["return"])&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;if(r=0,a)o=[o[0]&2,a.value];switch(o[0]){case 0:case 1:a=o;break;case 4:s.label++;return{value:o[1],done:false};case 5:s.label++;r=o[1];o=[0];continue;case 7:o=s.ops.pop();s.trys.pop();continue;default:if(!(a=s.trys,a=a.length>0&&a[a.length-1])&&(o[0]===6||o[0]===2)){s=0;continue}if(o[0]===3&&(!a||o[1]>a[0]&&o[1]<a[3])){s.label=o[1];break}if(o[0]===6&&s.label<a[1]){s.label=a[1];a=o;break}if(a&&s.label<a[2]){s.label=a[2];s.ops.push(o);break}if(a[2])s.ops.pop();s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e];r=0}finally{n=a=0}if(o[0]&5)throw o[1];return{value:o[0]?o[1]:void 0,done:true}}}var O=require("recoil");var j=require("lodash");var B=require("uuid");var U=require("react");var L=require("swr");var F=require("socket.io-client");function V(e){return e&&e.__esModule?e:{default:e}}var q=V(L);var W=V(F);var N=function(e){var t={},n=new Date,r=new Date;r.setDate(n.getDate()-1);var a=new Date;a.setDate(n.getDate()-7);var o=new Date;return o.setDate(n.getDate()-30),e.forEach(function(e){var s=new Date(e.createdAt),i=s.toDateString()===n.toDateString(),u=s.toDateString()===r.toDateString(),c=s>=a,l=s>=o,f;i?f="Today":u?f="Yesterday":c?f="Previous 7 days":l?f="Previous 30 days":f=s.toLocaleString("default",{month:"long",year:"numeric"}).split(" ").slice(0,1).join(" "),t[f]||(t[f]=[]),t[f].push(e)}),t};var z=[4186.01,4434.92,4698.63,4978.03,5274.04,5587.65,5919.91,6271.93,6644.88,7040,7458.62,7902.13],G=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],H=[],$=[];for(var J=1;J<=8;J++)for(var Y=0;Y<z.length;Y++){var K=z[Y];H.push(K/Math.pow(2,8-J)),$.push(G[Y]+J)}var X=[32,2e3],Q=H.filter(function(e,t){return H[t]>X[0]&&H[t]<X[1]}),Z=$.filter(function(e,t){return H[t]>X[0]&&H[t]<X[1]});var ee=/*#__PURE__*/function(){function e(t){var n=this;var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;i(this,e);if(this.fftResults=[],r){var a=r.length,o=r.sampleRate,s=new OfflineAudioContext({length:a,sampleRate:o}),u=s.createBufferSource();u.buffer=r;var c=s.createAnalyser();c.fftSize=8192,c.smoothingTimeConstant=.1,u.connect(c);var l=1/60,f=a/o,d=function(e){var t=l*e;t<f&&s.suspend(t).then(function(){var t=new Float32Array(c.frequencyBinCount);c.getFloatFrequencyData(t),n.fftResults.push(t),d(e+1)}),e===1?s.startRendering():s.resume()};u.start(0),d(1),this.audio=t,this.context=s,this.analyser=c,this.sampleRate=o,this.audioBuffer=r}else{var h=new AudioContext,p=h.createMediaElementSource(t),v=h.createAnalyser();v.fftSize=8192,v.smoothingTimeConstant=.1,p.connect(v),v.connect(h.destination),this.audio=t,this.context=h,this.analyser=v,this.sampleRate=this.context.sampleRate,this.audioBuffer=null}}l(e,[{key:"getFrequencies",value:function t(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"frequency",n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:-100,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:-30;var a=null;if(this.audioBuffer&&this.fftResults.length){var o=this.audio.currentTime/this.audio.duration,s=Math.min(o*this.fftResults.length|0,this.fftResults.length-1);a=this.fftResults[s]}return e.getFrequencies(this.analyser,this.sampleRate,a,t,n,r)}},{key:"resumeIfSuspended",value:function e(){var e=this;return o(function(){var t;return M(this,function(n){switch(n.label){case 0:t=e.context.state==="suspended";if(!t)return[3,2];return[4,e.context.resume()];case 1:t=n.sent();n.label=2;case 2:return[2,(t,true)]}})})()}}],[{key:"getFrequencies",value:function e(e,t,n){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"frequency",a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:-100,o=arguments.length>5&&arguments[5]!==void 0?arguments[5]:-30;n||(n=new Float32Array(e.frequencyBinCount),e.getFloatFrequencyData(n));var s=t/2,i=1/n.length*s,u,c,l;if(r==="music"||r==="voice"){var f=r==="voice"?Q:H,d=Array(f.length).fill(a);for(var h=0;h<n.length;h++){var p=h*i,v=n[h];for(var g=f.length-1;g>=0;g--)if(p>f[g]){d[g]=Math.max(d[g],v);break}}u=d,c=r==="voice"?Q:H,l=r==="voice"?Z:$}else u=Array.from(n),c=u.map(function(e,t){return i*t}),l=c.map(function(e){return"".concat(e.toFixed(2)," Hz")});var y=u.map(function(e){return Math.max(0,Math.min((e-a)/(o-a),1))});return{values:new Float32Array(y),frequencies:c,labels:l}}}]);return e}();globalThis.AudioAnalysis=ee;var et=/*#__PURE__*/function(){function e(){i(this,e)}l(e,[{key:"_packData",value:function e(e,t){return[new Uint8Array([t,t>>8]),new Uint8Array([t,t>>8,t>>16,t>>24])][e]}},{key:"pack",value:function e(e,t){if(t===null||t===void 0?void 0:t.bitsPerSample)if(t===null||t===void 0?void 0:t.channels){if(!(t===null||t===void 0?void 0:t.data))throw new Error('Missing "data"')}else throw new Error('Missing "channels"');else throw new Error('Missing "bitsPerSample"');var n=t.bitsPerSample,r=t.channels,a=t.data,o=["RIFF",this._packData(1,52),"WAVE","fmt ",this._packData(1,16),this._packData(0,1),this._packData(0,r.length),this._packData(1,e),this._packData(1,e*r.length*n/8),this._packData(0,r.length*n/8),this._packData(0,n),"data",this._packData(1,r[0].length*r.length*n/8),a],s=new Blob(o,{type:"audio/mpeg"}),i=URL.createObjectURL(s);return{blob:s,url:i,channelCount:r.length,sampleRate:e,duration:a.byteLength/(r.length*e*2)}}}],[{key:"floatTo16BitPCM",value:function e(e){var t=new ArrayBuffer(e.length*2),n=new DataView(t),r=0;for(var a=0;a<e.length;a++,r+=2){var o=Math.max(-1,Math.min(1,e[a]));n.setInt16(r,o<0?o*32768:o*32767,true)}return t}},{key:"mergeBuffers",value:function e(e,t){var n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n.buffer}}]);return e}();globalThis.WavPacker=et;var en="\nclass AudioProcessor extends AudioWorkletProcessor {\n\n  constructor() {\n    super();\n    this.port.onmessage = this.receive.bind(this);\n    this.initialize();\n  }\n\n  initialize() {\n    this.foundAudio = false;\n    this.recording = false;\n    this.chunks = [];\n  }\n\n  /**\n   * Concatenates sampled chunks into channels\n   * Format is chunk[Left[], Right[]]\n   */\n  readChannelData(chunks, channel = -1, maxChannels = 9) {\n    let channelLimit;\n    if (channel !== -1) {\n      if (chunks[0] && chunks[0].length - 1 < channel) {\n        throw new Error(\n          `Channel ${channel} out of range: max ${chunks[0].length}`\n        );\n      }\n      channelLimit = channel + 1;\n    } else {\n      channel = 0;\n      channelLimit = Math.min(chunks[0] ? chunks[0].length : 1, maxChannels);\n    }\n    const channels = [];\n    for (let n = channel; n < channelLimit; n++) {\n      const length = chunks.reduce((sum, chunk) => {\n        return sum + chunk[n].length;\n      }, 0);\n      const buffers = chunks.map((chunk) => chunk[n]);\n      const result = new Float32Array(length);\n      let offset = 0;\n      for (let i = 0; i < buffers.length; i++) {\n        result.set(buffers[i], offset);\n        offset += buffers[i].length;\n      }\n      channels[n] = result;\n    }\n    return channels;\n  }\n\n  /**\n   * Combines parallel audio data into correct format,\n   * channels[Left[], Right[]] to float32Array[LRLRLRLR...]\n   */\n  formatAudioData(channels) {\n    if (channels.length === 1) {\n      // Simple case is only one channel\n      const float32Array = channels[0].slice();\n      const meanValues = channels[0].slice();\n      return { float32Array, meanValues };\n    } else {\n      const float32Array = new Float32Array(\n        channels[0].length * channels.length\n      );\n      const meanValues = new Float32Array(channels[0].length);\n      for (let i = 0; i < channels[0].length; i++) {\n        const offset = i * channels.length;\n        let meanValue = 0;\n        for (let n = 0; n < channels.length; n++) {\n          float32Array[offset + n] = channels[n][i];\n          meanValue += channels[n][i];\n        }\n        meanValues[i] = meanValue / channels.length;\n      }\n      return { float32Array, meanValues };\n    }\n  }\n\n  /**\n   * Converts 32-bit float data to 16-bit integers\n   */\n  floatTo16BitPCM(float32Array) {\n    const buffer = new ArrayBuffer(float32Array.length * 2);\n    const view = new DataView(buffer);\n    let offset = 0;\n    for (let i = 0; i < float32Array.length; i++, offset += 2) {\n      let s = Math.max(-1, Math.min(1, float32Array[i]));\n      view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7fff, true);\n    }\n    return buffer;\n  }\n\n  /**\n   * Retrieves the most recent amplitude values from the audio stream\n   * @param {number} channel\n   */\n  getValues(channel = -1) {\n    const channels = this.readChannelData(this.chunks, channel);\n    const { meanValues } = this.formatAudioData(channels);\n    return { meanValues, channels };\n  }\n\n  /**\n   * Exports chunks as an audio/wav file\n   */\n  export() {\n    const channels = this.readChannelData(this.chunks);\n    const { float32Array, meanValues } = this.formatAudioData(channels);\n    const audioData = this.floatTo16BitPCM(float32Array);\n    return {\n      meanValues: meanValues,\n      audio: {\n        bitsPerSample: 16,\n        channels: channels,\n        data: audioData,\n      },\n    };\n  }\n\n  receive(e) {\n    const { event, id } = e.data;\n    let receiptData = {};\n    switch (event) {\n      case 'start':\n        this.recording = true;\n        break;\n      case 'stop':\n        this.recording = false;\n        break;\n      case 'clear':\n        this.initialize();\n        break;\n      case 'export':\n        receiptData = this.export();\n        break;\n      case 'read':\n        receiptData = this.getValues();\n        break;\n      default:\n        break;\n    }\n    // Always send back receipt\n    this.port.postMessage({ event: 'receipt', id, data: receiptData });\n  }\n\n  sendChunk(chunk) {\n    const channels = this.readChannelData([chunk]);\n    const { float32Array, meanValues } = this.formatAudioData(channels);\n    const rawAudioData = this.floatTo16BitPCM(float32Array);\n    const monoAudioData = this.floatTo16BitPCM(meanValues);\n    this.port.postMessage({\n      event: 'chunk',\n      data: {\n        mono: monoAudioData,\n        raw: rawAudioData,\n      },\n    });\n  }\n\n  process(inputList, outputList, parameters) {\n    // Copy input to output (e.g. speakers)\n    // Note that this creates choppy sounds with Mac products\n    const sourceLimit = Math.min(inputList.length, outputList.length);\n    for (let inputNum = 0; inputNum < sourceLimit; inputNum++) {\n      const input = inputList[inputNum];\n      const output = outputList[inputNum];\n      const channelCount = Math.min(input.length, output.length);\n      for (let channelNum = 0; channelNum < channelCount; channelNum++) {\n        input[channelNum].forEach((sample, i) => {\n          output[channelNum][i] = sample;\n        });\n      }\n    }\n    const inputs = inputList[0];\n    // There's latency at the beginning of a stream before recording starts\n    // Make sure we actually receive audio data before we start storing chunks\n    let sliceIndex = 0;\n    if (!this.foundAudio) {\n      for (const channel of inputs) {\n        sliceIndex = 0; // reset for each channel\n        if (this.foundAudio) {\n          break;\n        }\n        if (channel) {\n          for (const value of channel) {\n            if (value !== 0) {\n              // find only one non-zero entry in any channel\n              this.foundAudio = true;\n              break;\n            } else {\n              sliceIndex++;\n            }\n          }\n        }\n      }\n    }\n    if (inputs && inputs[0] && this.foundAudio && this.recording) {\n      // We need to copy the TypedArray, because the `process`\n      // internals will reuse the same buffer to hold each input\n      const chunk = inputs.map((input) => input.slice(sliceIndex));\n      this.chunks.push(chunk);\n      this.sendChunk(chunk);\n    }\n    return true;\n  }\n}\n\nregisterProcessor('audio_processor', AudioProcessor);\n",er=new Blob([en],{type:"application/javascript"}),ea=URL.createObjectURL(er),eo=ea;var es=/*#__PURE__*/function(){function e(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},n=t.sampleRate,r=n===void 0?24e3:n,a=t.outputToSpeakers,o=a===void 0?false:a,s=t.debug,u=s===void 0?false:s;i(this,e);this.scriptSrc=eo,this.sampleRate=r,this.outputToSpeakers=o,this.debug=!!u,this._deviceChangeCallback=null,this._devices=[],this.stream=null,this.processor=null,this.source=null,this.node=null,this.recording=false,this._lastEventId=0,this.eventReceipts={},this.eventTimeout=5e3,this._chunkProcessor=function(){},this._chunkProcessorSize=undefined,this._chunkProcessorBuffer={raw:new ArrayBuffer(0),mono:new ArrayBuffer(0)}}l(e,[{key:"log",value:function e(){return this.debug&&this.log.apply(this,arguments),true}},{key:"getSampleRate",value:function e(){return this.sampleRate}},{key:"getStatus",value:function e(){return this.processor?this.recording?"recording":"paused":"ended"}},{key:"_event",value:function e(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;var r=this;return o(function(){var a,o,s;return M(this,function(i){switch(i.label){case 0:if(n=n||r.processor,!n)throw new Error("Can not send events without recording first");a={event:e,id:r._lastEventId++,data:t};n.port.postMessage(a);o=new Date().valueOf();i.label=1;case 1:if(!!r.eventReceipts[a.id])return[3,4];if(new Date().valueOf()-o>r.eventTimeout)throw new Error('Timeout waiting for "'.concat(e,'" event'));return[4,new Promise(function(e){return setTimeout(function(){return e(true)},1)})];case 2:i.sent();i.label=3;case 3:return[3,1];case 4:s=r.eventReceipts[a.id];return[2,(delete r.eventReceipts[a.id],s)]}})})()}},{key:"listenForDeviceChange",value:function e(e){if(e===null&&this._deviceChangeCallback)navigator.mediaDevices.removeEventListener("devicechange",this._deviceChangeCallback),this._deviceChangeCallback=null;else if(e!==null){var t=this;var n=0,r=[],a=function(e){return e.map(function(e){return e.deviceId}).sort().join(",")},s=/*#__PURE__*/function(){var s=o(function(){var o,s;return M(this,function(i){switch(i.label){case 0:o=++n;return[4,t.listDevices()];case 1:s=i.sent();o===n&&a(r)!==a(s)&&(r=s,e(s.slice()));return[2]}})});return function e(){return s.apply(this,arguments)}}();navigator.mediaDevices.addEventListener("devicechange",s),s(),this._deviceChangeCallback=s}return true}},{key:"requestPermission",value:function e(){return o(function(){var e,t;return M(this,function(n){switch(n.label){case 0:return[4,navigator.permissions.query({name:"microphone"})];case 1:e=n.sent();if(!(e.state==="denied"))return[3,2];window.alert("You must grant microphone access to use this feature.");return[3,6];case 2:if(!(e.state==="prompt"))return[3,6];n.label=3;case 3:n.trys.push([3,5,,6]);return[4,navigator.mediaDevices.getUserMedia({audio:!0})];case 4:n.sent().getTracks().forEach(function(e){return e.stop()});return[3,6];case 5:t=n.sent();window.alert("You must grant microphone access to use this feature.");return[3,6];case 6:return[2,true]}})})()}},{key:"listDevices",value:function e(){var e=this;return o(function(){var t,n,r,a,o;return M(this,function(s){switch(s.label){case 0:if(!navigator.mediaDevices||!("enumerateDevices"in navigator.mediaDevices))throw new Error("Could not request user devices");return[4,e.requestPermission()];case 1:s.sent();return[4,navigator.mediaDevices.enumerateDevices()];case 2:t=s.sent().filter(function(e){return e.kind==="audioinput"}),n=t.findIndex(function(e){return e.deviceId==="default"}),r=[];if(n!==-1){a=t.splice(n,1)[0],o=t.findIndex(function(e){return e.groupId===a.groupId});o!==-1&&(a=t.splice(o,1)[0]),a.default=true,r.push(a)}return[2,r.concat(t)]}})})()}},{key:"begin",value:function e(e){var t=this;return o(function(){var n,r,a,o,s,i,u,c;return M(this,function(l){switch(l.label){case 0:if(t.processor)throw new Error("Already connected: please call .end() to start a new session");if(!navigator.mediaDevices||!("getUserMedia"in navigator.mediaDevices))throw new Error("Could not request user media");l.label=1;case 1:l.trys.push([1,3,,4]);n={audio:!0};e&&(n.audio={deviceId:{exact:e}});return[4,navigator.mediaDevices.getUserMedia(n)];case 2:t.stream=l.sent();return[3,4];case 3:r=l.sent();throw new Error("Could not start media stream");case 4:a=new AudioContext({sampleRate:t.sampleRate}),o=a.createMediaStreamSource(t.stream);l.label=5;case 5:l.trys.push([5,7,,8]);return[4,a.audioWorklet.addModule(t.scriptSrc)];case 6:l.sent();return[3,8];case 7:s=l.sent();throw console.error(s),new Error("Could not add audioWorklet module: ".concat(t.scriptSrc));case 8:i=new AudioWorkletNode(a,"audio_processor");i.port.onmessage=function(e){var n=e.data,r=n.event,a=n.id,o=n.data;if(r==="receipt")t.eventReceipts[a]=o;else if(r==="chunk")if(t._chunkProcessorSize){var s=t._chunkProcessorBuffer;t._chunkProcessorBuffer={raw:et.mergeBuffers(s.raw,o.raw),mono:et.mergeBuffers(s.mono,o.mono)},t._chunkProcessorBuffer.mono.byteLength>=t._chunkProcessorSize&&(t._chunkProcessor(t._chunkProcessorBuffer),t._chunkProcessorBuffer={raw:new ArrayBuffer(0),mono:new ArrayBuffer(0)})}else t._chunkProcessor(o)};u=o.connect(i),c=a.createAnalyser();return[2,(c.fftSize=8192,c.smoothingTimeConstant=.1,u.connect(c),t.outputToSpeakers&&(console.warn("Warning: Output to speakers may affect sound quality,\nespecially due to system audio feedback preventative measures.\nuse only for debugging"),c.connect(a.destination)),t.source=o,t.node=u,t.analyser=c,t.processor=i,true)]}})})()}},{key:"getFrequencies",value:function e(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"frequency",t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:-100,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:-30;if(!this.processor)throw new Error("Session ended: please call .begin() first");return ee.getFrequencies(this.analyser,this.sampleRate,null,e,t,n)}},{key:"pause",value:function e(){var e=this;return o(function(){return M(this,function(t){switch(t.label){case 0:if(e.processor){if(!e.recording)throw new Error("Already paused: please call .record() first")}else throw new Error("Session ended: please call .begin() first");e._chunkProcessorBuffer.raw.byteLength&&e._chunkProcessor(e._chunkProcessorBuffer),e.log("Pausing ...");return[4,e._event("stop")];case 1:return[2,(t.sent(),e.recording=false,true)]}})})()}},{key:"record",value:function e(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:function(){},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:8192;var n=this;return o(function(){return M(this,function(r){switch(r.label){case 0:if(n.processor){if(n.recording)throw new Error("Already recording: please call .pause() first");if(typeof e!="function")throw new Error("chunkProcessor must be a function")}else throw new Error("Session ended: please call .begin() first");n._chunkProcessor=e,n._chunkProcessorSize=t,n._chunkProcessorBuffer={raw:new ArrayBuffer(0),mono:new ArrayBuffer(0)},n.log("Recording ...");return[4,n._event("start")];case 1:return[2,(r.sent(),n.recording=true,true)]}})})()}},{key:"clear",value:function e(){var e=this;return o(function(){return M(this,function(t){switch(t.label){case 0:if(!e.processor)throw new Error("Session ended: please call .begin() first");return[4,e._event("clear")];case 1:return[2,(t.sent(),true)]}})})()}},{key:"read",value:function e(){var e=this;return o(function(){return M(this,function(t){switch(t.label){case 0:if(!e.processor)throw new Error("Session ended: please call .begin() first");e.log("Reading ...");return[4,e._event("read")];case 1:return[2,t.sent()]}})})()}},{key:"save",value:function e(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:false;var t=this;return o(function(){var n;return M(this,function(r){switch(r.label){case 0:if(!t.processor)throw new Error("Session ended: please call .begin() first");if(!e&&t.recording)throw new Error("Currently recording: please call .pause() first, or call .save(true) to force");t.log("Exporting ...");return[4,t._event("export")];case 1:n=r.sent();return[2,new et().pack(t.sampleRate,n.audio)]}})})()}},{key:"end",value:function e(){var e=this;return o(function(){var t,n;return M(this,function(r){switch(r.label){case 0:if(!e.processor)throw new Error("Session ended: please call .begin() first");t=e.processor;e.log("Stopping ...");return[4,e._event("stop")];case 1:r.sent(),e.recording=false,e.stream.getTracks().forEach(function(e){return e.stop()}),e.log("Exporting ...");return[4,e._event("export",{},t)];case 2:n=r.sent();return[2,(e.processor.disconnect(),e.source.disconnect(),e.node.disconnect(),e.analyser.disconnect(),e.stream=null,e.processor=null,e.source=null,e.node=null,new et().pack(e.sampleRate,n.audio))]}})})()}},{key:"quit",value:function e(){var e=this;return o(function(){var t;return M(this,function(n){switch(n.label){case 0:e.listenForDeviceChange(null);t=e.processor;if(!t)return[3,2];return[4,e.end()];case 1:t=n.sent();n.label=2;case 2:return[2,(t,true)]}})})()}}],[{key:"decode",value:function e(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:24e3,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:-1;return o(function(){var r,a,o,s,i,u,c,l,f,d;return M(this,function(h){switch(h.label){case 0:r=new AudioContext({sampleRate:t});if(!v(e,Blob))return[3,2];if(n!==-1)throw new Error('Can not specify "fromSampleRate" when reading from Blob');o=e;return[4,o.arrayBuffer()];case 1:a=h.sent();return[3,5];case 2:if(!v(e,ArrayBuffer))return[3,3];if(n!==-1)throw new Error('Can not specify "fromSampleRate" when reading from ArrayBuffer');a=e,o=new Blob([a],{type:"audio/wav"});return[3,5];case 3:if(v(e,Int16Array)){i=e,s=new Float32Array(e.length);for(u=0;u<e.length;u++)s[u]=e[u]/32768}else if(v(e,Float32Array))s=e;else if(v(e,Array))s=new Float32Array(e);else throw new Error('"audioData" must be one of: Blob, Float32Arrray, Int16Array, ArrayBuffer, Array<number>');if(n===-1)throw new Error('Must specify "fromSampleRate" when reading from Float32Array, In16Array or Array');if(n<3e3)throw new Error('Minimum "fromSampleRate" is 3000 (3kHz)');i||(i=et.floatTo16BitPCM(s));c={bitsPerSample:16,channels:[s],data:i};o=new et().pack(n,c).blob;return[4,o.arrayBuffer()];case 4:a=h.sent();h.label=5;case 5:return[4,r.decodeAudioData(a)];case 6:l=h.sent(),f=l.getChannelData(0),d=URL.createObjectURL(o);return[2,{blob:o,url:d,values:f,audioBuffer:l}]}})})()}}]);return e}();globalThis.WavRecorder=es;var ei="\nclass StreamProcessor extends AudioWorkletProcessor {\n  constructor() {\n    super();\n    this.hasStarted = false;\n    this.hasInterrupted = false;\n    this.outputBuffers = [];\n    this.bufferLength = 128;\n    this.write = { buffer: new Float32Array(this.bufferLength), trackId: null };\n    this.writeOffset = 0;\n    this.trackSampleOffsets = {};\n    this.port.onmessage = (event) => {\n      if (event.data) {\n        const payload = event.data;\n        if (payload.event === 'write') {\n          const int16Array = payload.buffer;\n          const float32Array = new Float32Array(int16Array.length);\n          for (let i = 0; i < int16Array.length; i++) {\n            float32Array[i] = int16Array[i] / 0x8000; // Convert Int16 to Float32\n          }\n          this.writeData(float32Array, payload.trackId);\n        } else if (\n          payload.event === 'offset' ||\n          payload.event === 'interrupt'\n        ) {\n          const requestId = payload.requestId;\n          const trackId = this.write.trackId;\n          const offset = this.trackSampleOffsets[trackId] || 0;\n          this.port.postMessage({\n            event: 'offset',\n            requestId,\n            trackId,\n            offset,\n          });\n          if (payload.event === 'interrupt') {\n            this.hasInterrupted = true;\n          }\n        } else {\n          throw new Error(`Unhandled event \"${payload.event}\"`);\n        }\n      }\n    };\n  }\n\n  writeData(float32Array, trackId = null) {\n    let { buffer } = this.write;\n    let offset = this.writeOffset;\n    for (let i = 0; i < float32Array.length; i++) {\n      buffer[offset++] = float32Array[i];\n      if (offset >= buffer.length) {\n        this.outputBuffers.push(this.write);\n        this.write = { buffer: new Float32Array(this.bufferLength), trackId };\n        buffer = this.write.buffer;\n        offset = 0;\n      }\n    }\n    this.writeOffset = offset;\n    return true;\n  }\n\n  process(inputs, outputs, parameters) {\n    const output = outputs[0];\n    const outputChannelData = output[0];\n    const outputBuffers = this.outputBuffers;\n    if (this.hasInterrupted) {\n      this.port.postMessage({ event: 'stop' });\n      return false;\n    } else if (outputBuffers.length) {\n      this.hasStarted = true;\n      const { buffer, trackId } = outputBuffers.shift();\n      for (let i = 0; i < outputChannelData.length; i++) {\n        outputChannelData[i] = buffer[i] || 0;\n      }\n      if (trackId) {\n        this.trackSampleOffsets[trackId] =\n          this.trackSampleOffsets[trackId] || 0;\n        this.trackSampleOffsets[trackId] += buffer.length;\n      }\n      return true;\n    } else if (this.hasStarted) {\n      this.port.postMessage({ event: 'stop' });\n      return false;\n    } else {\n      return true;\n    }\n  }\n}\n\nregisterProcessor('stream_processor', StreamProcessor);\n",eu=new Blob([ei],{type:"application/javascript"}),ec=URL.createObjectURL(eu),el=ec;var ef=/*#__PURE__*/function(){function e(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},n=t.sampleRate,r=n===void 0?24e3:n,a=t.onStop;i(this,e);this.scriptSrc=el,this.onStop=a,this.sampleRate=r,this.context=null,this.stream=null,this.analyser=null,this.trackSampleOffsets={},this.interruptedTrackIds={}}l(e,[{key:"connect",value:function e(){var e=this;return o(function(){var t,n,r;return M(this,function(a){switch(a.label){case 0:e.context=new AudioContext({sampleRate:e.sampleRate});t=e.context.state==="suspended";if(!t)return[3,2];return[4,e.context.resume()];case 1:t=a.sent();a.label=2;case 2:t;a.label=3;case 3:a.trys.push([3,5,,6]);return[4,e.context.audioWorklet.addModule(e.scriptSrc)];case 4:a.sent();return[3,6];case 5:n=a.sent();throw console.error(n),new Error("Could not add audioWorklet module: ".concat(e.scriptSrc));case 6:r=e.context.createAnalyser();return[2,(r.fftSize=8192,r.smoothingTimeConstant=.1,e.analyser=r,true)]}})})()}},{key:"getFrequencies",value:function e(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"frequency",t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:-100,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:-30;if(!this.analyser)throw new Error("Not connected, please call .connect() first");return ee.getFrequencies(this.analyser,this.sampleRate,null,e,t,n)}},{key:"_start",value:function e(){var e=this;var t=new AudioWorkletNode(this.context,"stream_processor");return t.connect(this.context.destination),t.port.onmessage=function(n){var r,a;var o=n.data,s=o.event;if(s==="stop")(r=(a=e).onStop)===null||r===void 0?void 0:r.call(a),t.disconnect(),e.stream=null;else if(s==="offset"){var i=n.data,u=i.requestId,c=i.trackId,l=i.offset,f=l/e.sampleRate;e.trackSampleOffsets[u]={trackId:c,offset:l,currentTime:f}}},this.analyser.disconnect(),t.connect(this.analyser),this.stream=t,true}},{key:"add16BitPCM",value:function e(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"default";if(typeof t!="string")throw new Error("trackId must be a string");if(this.interruptedTrackIds[t])return;this.stream||this._start();var n;if(v(e,Int16Array))n=e;else if(v(e,ArrayBuffer))n=new Int16Array(e);else throw new Error("argument must be Int16Array or ArrayBuffer");return this.stream.port.postMessage({event:"write",buffer:n,trackId:t}),n}},{key:"getTrackSampleOffset",value:function e(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:false;var t=this;return o(function(){var n,r,a;return M(this,function(o){switch(o.label){case 0:if(!t.stream)return[2,null];n=crypto.randomUUID();t.stream.port.postMessage({event:e?"interrupt":"offset",requestId:n});o.label=1;case 1:if(!!r)return[3,4];r=t.trackSampleOffsets[n];return[4,new Promise(function(e){return setTimeout(function(){return e()},1)})];case 2:o.sent();o.label=3;case 3:return[3,1];case 4:a=r.trackId;return[2,(e&&a&&(t.interruptedTrackIds[a]=true),r)]}})})()}},{key:"interrupt",value:function e(){var e=this;return o(function(){return M(this,function(t){return[2,e.getTrackSampleOffset(true)]})})()}}]);return e}();globalThis.WavStreamPlayer=ef;var ed=O.atom({key:"ThreadIdToResume",default:undefined}),eh=O.atom({key:"ChatProfile",default:undefined}),ep=O.atom({key:"SessionId",default:B.v4()}),ev=O.selector({key:"SessionIdSelector",get:function(e){var t=e.get;return t(ep)},set:function(e,t){var n=e.set;return n(ep,v(t,O.DefaultValue)?B.v4():t)}}),eg=O.atom({key:"Session",dangerouslyAllowMutability:true,default:undefined}),ey=O.atom({key:"Actions",default:[]}),em=O.atom({key:"Messages",dangerouslyAllowMutability:true,default:[]}),ek=O.atom({key:"TokenCount",default:0}),ew=O.atom({key:"Loading",default:false}),eb=O.atom({key:"AskUser",default:undefined}),eS=O.atom({key:"WavRecorder",dangerouslyAllowMutability:true,default:new es}),eA=O.atom({key:"WavStreamPlayer",dangerouslyAllowMutability:true,default:new ef}),eR=O.atom({key:"AudioConnection",default:"off"}),e_=O.atom({key:"isAiSpeaking",default:false}),eC=O.atom({key:"CallFn",default:undefined}),ex=O.atom({key:"ChatSettings",default:[]}),eE=O.selector({key:"ChatSettingsValue/Default",get:function(e){var t=e.get;return t(ex).reduce(function(e,t){return e[t.id]=t.initial,e},{})}}),eI=O.atom({key:"ChatSettingsValue",default:eE}),eP=O.atom({key:"DisplayElements",default:[]}),eD=O.atom({key:"TasklistElements",default:[]}),eT=O.atom({key:"FirstUserInteraction",default:undefined}),eM=O.atom({key:"User",default:undefined}),eO=O.atom({key:"ChainlitConfig",default:undefined}),ej=O.atom({key:"AuthConfig",default:undefined}),eB=O.atom({key:"ThreadHistory",default:{threads:undefined,currentThreadId:undefined,timeGroupedThreads:undefined,pageInfo:undefined},effects:[function(e){var t=e.setSelf,n=e.onSet;n(function(e,n){var r=e===null||e===void 0?void 0:e.timeGroupedThreads;(e===null||e===void 0?void 0:e.threads)&&!j.isEqual(e.threads,n===null||n===void 0?void 0:n.timeGroupedThreads)&&(r=N(e.threads)),t(R(S({},e),{timeGroupedThreads:r}))})}]}),eU=O.atom({key:"SideView",default:undefined}),eL=O.atom({key:"CurrentThreadId",default:undefined});var eF=function(){var e=O.useRecoilValue(ew),t=O.useRecoilValue(eP),n=O.useRecoilValue(eD),r=O.useRecoilValue(ey),a=O.useRecoilValue(eg),o=O.useRecoilValue(eb),s=O.useRecoilValue(eC),i=O.useRecoilValue(ex),u=O.useRecoilValue(eI),c=O.useRecoilValue(eE),l=(a===null||a===void 0?void 0:a.socket.connected)&&!(a===null||a===void 0?void 0:a.error),f=!l||e||(o===null||o===void 0?void 0:o.spec.type)==="file"||(o===null||o===void 0?void 0:o.spec.type)==="action";return{actions:r,askUser:o,callFn:s,chatSettingsDefaultValue:c,chatSettingsInputs:i,chatSettingsValue:u,connected:l,disabled:f,elements:t,error:a===null||a===void 0?void 0:a.error,loading:e,tasklists:n}};var eV=function(e){var t=[];var n=true,r=false,a=undefined;try{for(var o=e[Symbol.iterator](),s;!(n=(s=o.next()).done);n=true){var i=s.value;t=eW(t,i)}}catch(e){r=true;a=e}finally{try{if(!n&&o.return!=null){o.return()}}finally{if(r){throw a}}}return t},eq=function(e,t){if(e.length-1===t)return true;for(var n=t+1;n<e.length;n++)if(!e[n].streaming)return false;return true},eW=function(e,t){return eH(e,t.id)?e$(e,t.id,t):"parentId"in t&&t.parentId?ez(e,t.parentId,t):"indent"in t&&t.indent&&t.indent>0?eN(e,t.indent,t):E(e).concat([t])},eN=function(e,t,n){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0;var a=E(e);if(a.length===0)return E(a).concat([n]);{var o=a.length-1,s=a[o];return s.steps=s.steps||[],r+1===t?(s.steps=E(s.steps).concat([n]),a[o]=S({},s),a):(s.steps=eN(s.steps,t,n,r+1),a[o]=S({},s),a)}},ez=function(e,t,n){var r=E(e);for(var a=0;a<r.length;a++){var o=r[a];j.isEqual(o.id,t)?(o.steps=o.steps?E(o.steps).concat([n]):[n],r[a]=S({},o)):eH(r,t)&&o.steps&&(o.steps=ez(o.steps,t,n),r[a]=S({},o))}return r},eG=function(e,t){var n=true,r=false,a=undefined;try{for(var o=e[Symbol.iterator](),s;!(n=(s=o.next()).done);n=true){var i=s.value;if(j.isEqual(i.id,t))return i;if(i.steps&&i.steps.length>0){var u=eG(i.steps,t);if(u)return u}}}catch(e){r=true;a=e}finally{try{if(!n&&o.return!=null){o.return()}}finally{if(r){throw a}}}},eH=function(e,t){return eG(e,t)!==undefined},e$=function(e,t,n){var r=E(e);for(var a=0;a<r.length;a++){var o=r[a];j.isEqual(o.id,t)?r[a]=S({steps:o.steps},n):eH(r,t)&&o.steps&&(o.steps=e$(o.steps,t,n),r[a]=S({},o))}return r},eJ=function(e,t){var n=E(e);for(var r=0;r<n.length;r++){var a=n[r];a.id===t?n=E(n.slice(0,r)).concat(E(n.slice(r+1))):eH(n,t)&&a.steps&&(a.steps=eJ(a.steps,t),n[r]=S({},a))}return n},eY=function(e,t,n,r,a){var o=E(e);for(var s=0;s<o.length;s++){var i=o[s];j.isEqual(i.id,t)?("content"in i&&i.content!==undefined?r?i.content=n:i.content+=n:a?"input"in i&&i.input!==undefined&&(r?i.input=n:i.input+=n):"output"in i&&i.output!==undefined&&(r?i.output=n:i.output+=n),o[s]=S({},i)):i.steps&&(i.steps=eY(i.steps,t,n,r,a),o[s]=S({},i))}return o};var eK=function(){var e=x(O.useRecoilState(ej),2),t=e[0],n=e[1],r=x(O.useRecoilState(eM),2),a=r[0],o=r[1],s=O.useSetRecoilState(eB);return{authConfig:t,setAuthConfig:n,user:a,setUser:o,setThreadHistory:s}};var eX=/*#__PURE__*/function(){var e=o(function(e,t){var n;return M(this,function(r){switch(r.label){case 0:return[4,e.get(t)];case 1:return[2,(n=r.sent())===null||n===void 0?void 0:n.json()]}})});return function t(t,n){return e.apply(this,arguments)}}(),eQ=function(e){var t=new e8("","webapp");return Object.assign(t,e),t};function eZ(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var n=d({},b(t));var r=U.useContext(e7),a=eK(),o=a.setUser,s=U.useMemo(function(){return function(e){var t=x(e,1),a=t[0];n.onErrorRetry||(n.onErrorRetry=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++){t[n]=arguments[n]}var r;var a=x(t,1),s=a[0];if(s.status===401){o(null);return}return(r=L.SWRConfig.defaultValue).onErrorRetry.apply(r,E(t))});var s=eQ(r);return s.on401=s.onError=undefined,eX(s,a)}},[r]),i=U.useMemo(function(){return e?[e]:null},[e]);return q.default(i,s,n)}var e0=function(){var e=eK(),t=e.authConfig,n=e.setAuthConfig,r=eZ(t?null:"/auth/config"),a=r.data,o=r.isLoading;return U.useEffect(function(){a&&n(a)},[a,n]),{authConfig:t,isLoading:o}};var e1=function(){var e=U.useContext(e7),t=eK(),n=t.setUser,r=t.setThreadHistory;return{logout:/*#__PURE__*/o(function(){var t;var a=arguments;return M(this,function(o){switch(o.label){case 0:t=a.length>0&&a[0]!==void 0?a[0]:false;return[4,e.logout()];case 1:o.sent(),n(undefined),r(undefined),t&&window.location.reload();return[2]}})})}};var e2=function(){var e=eK(),t=e.user,n=e.setUser,r=eZ("/user"),a=r.data,o=r.error,s=r.isLoading,i=r.mutate;return U.useEffect(function(){a?n(a):s&&n(undefined)},[a,s,n]),U.useEffect(function(){o&&n(null)},[o]),{user:t,setUserFromAPI:i}};var e3=function(){var e=e0(),t=e.authConfig,n=e1(),r=n.logout,a=e2(),o=a.user,s=a.setUserFromAPI,i=!!t&&(!t.requireLogin||o!==undefined);return t&&!t.requireLogin?{data:t,user:null,isReady:i,isAuthenticated:true,logout:function(){return Promise.resolve()},setUserFromAPI:function(){return Promise.resolve()}}:{data:t,user:o,isReady:i,isAuthenticated:!!o,logout:r,setUserFromAPI:s}};var e4=/*#__PURE__*/function(e){p(t,e);function t(e,n,r){i(this,t);var a;a=s(this,t,[e]),a.status=n,a.detail=r;return a}l(t,[{key:"toString",value:function e(){return this.detail?"".concat(this.message,": ").concat(this.detail):this.message}}]);return t}(D(Error)),e6=/*#__PURE__*/function(){function e(t,n,r,a){i(this,e);this.httpEndpoint=t;this.type=n;this.on401=r;this.onError=a}l(e,[{key:"buildEndpoint",value:function e(e){return this.httpEndpoint.endsWith("/")?"".concat(this.httpEndpoint.slice(0,-1)).concat(e):"".concat(this.httpEndpoint).concat(e)}},{key:"getDetailFromErrorResponse",value:function e(e){return o(function(){var t,n;return M(this,function(r){switch(r.label){case 0:r.trys.push([0,2,,3]);return[4,e.json()];case 1:return[2,(t=r.sent())===null||t===void 0?void 0:t.detail];case 2:n=r.sent();console.error("Unable to parse error response",n);return[3,3];case 3:return[2]}})})()}},{key:"handleRequestError",value:function e(e){v(e,e4)&&(e.status===401&&this.on401&&this.on401(),this.onError&&this.onError(e)),console.error(e)}},{key:"fetch",value:function e(e,t,n,r){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{};var s=this;return o(function(){var o,i,u,c;return M(this,function(l){switch(l.label){case 0:l.trys.push([0,4,,5]);v(n,FormData)?o=n:(a["Content-Type"]="application/json",o=n?JSON.stringify(n):null);return[4,fetch(s.buildEndpoint(t),{method:e,credentials:"include",headers:a,signal:r,body:o})];case 1:i=l.sent();if(!!i.ok)return[3,3];return[4,s.getDetailFromErrorResponse(i)];case 2:u=l.sent();throw new e4(i.statusText,i.status,u);case 3:return[2,i];case 4:c=l.sent();throw s.handleRequestError(c),c;case 5:return[2]}})})()}},{key:"get",value:function e(e){var t=this;return o(function(){return M(this,function(n){switch(n.label){case 0:return[4,t.fetch("GET",e)];case 1:return[2,n.sent()]}})})()}},{key:"post",value:function e(e,t,n){var r=this;return o(function(){return M(this,function(a){switch(a.label){case 0:return[4,r.fetch("POST",e,t,n)];case 1:return[2,a.sent()]}})})()}},{key:"put",value:function e(e,t){var n=this;return o(function(){return M(this,function(r){switch(r.label){case 0:return[4,n.fetch("PUT",e,t)];case 1:return[2,r.sent()]}})})()}},{key:"patch",value:function e(e,t){var n=this;return o(function(){return M(this,function(r){switch(r.label){case 0:return[4,n.fetch("PATCH",e,t)];case 1:return[2,r.sent()]}})})()}},{key:"delete",value:function e(e,t){var n=this;return o(function(){return M(this,function(r){switch(r.label){case 0:return[4,n.fetch("DELETE",e,t)];case 1:return[2,r.sent()]}})})()}}]);return e}(),e8=/*#__PURE__*/function(e){p(t,e);function t(){i(this,t);return s(this,t,arguments)}l(t,[{key:"headerAuth",value:function e(){var e=this;return o(function(){return M(this,function(t){switch(t.label){case 0:return[4,e.post("/auth/header",{})];case 1:return[2,t.sent().json()]}})})()}},{key:"jwtAuth",value:function e(e){var t=this;return o(function(){return M(this,function(n){switch(n.label){case 0:return[4,t.fetch("POST","/auth/jwt",undefined,undefined,{Authorization:"Bearer ".concat(e)})];case 1:return[2,n.sent().json()]}})})()}},{key:"passwordAuth",value:function e(e){var t=this;return o(function(){return M(this,function(n){switch(n.label){case 0:return[4,t.post("/login",e)];case 1:return[2,n.sent().json()]}})})()}},{key:"getUser",value:function e(){var e=this;return o(function(){return M(this,function(t){switch(t.label){case 0:return[4,e.get("/user")];case 1:return[2,t.sent().json()]}})})()}},{key:"logout",value:function e(){var e=this;return o(function(){return M(this,function(t){switch(t.label){case 0:return[4,e.post("/logout",{})];case 1:return[2,t.sent().json()]}})})()}},{key:"setFeedback",value:function e(e){var t=this;return o(function(){return M(this,function(n){switch(n.label){case 0:return[4,t.put("/feedback",{feedback:e})];case 1:return[2,n.sent().json()]}})})()}},{key:"deleteFeedback",value:function e(e){var t=this;return o(function(){return M(this,function(n){switch(n.label){case 0:return[4,t.delete("/feedback",{feedbackId:e})];case 1:return[2,n.sent().json()]}})})()}},{key:"listThreads",value:function e(e,t){var n=this;return o(function(){return M(this,function(r){switch(r.label){case 0:return[4,n.post("/project/threads",{pagination:e,filter:t})];case 1:return[2,r.sent().json()]}})})()}},{key:"renameThread",value:function e(e,t){var n=this;return o(function(){return M(this,function(r){switch(r.label){case 0:return[4,n.put("/project/thread",{threadId:e,name:t})];case 1:return[2,r.sent().json()]}})})()}},{key:"deleteThread",value:function e(e){var t=this;return o(function(){return M(this,function(n){switch(n.label){case 0:return[4,t.delete("/project/thread",{threadId:e})];case 1:return[2,n.sent().json()]}})})()}},{key:"uploadFile",value:function e(e,t,n){var r=this;var a=new XMLHttpRequest;a.withCredentials=true;var o=new Promise(function(o,s){var i=new FormData;i.append("file",e),a.open("POST",r.buildEndpoint("/project/file?session_id=".concat(n)),true),a.upload.onprogress=function(e){if(e.lengthComputable){var n=e.loaded/e.total*100;t(n)}},a.onload=function(){if(a.status===200){var e=JSON.parse(a.responseText);o(e)}else s("Upload failed")},a.onerror=function(){s("Upload error")},a.send(i)});return{xhr:a,promise:o}}},{key:"callAction",value:function e(e,t){var n=this;return o(function(){return M(this,function(r){switch(r.label){case 0:return[4,n.post("/project/action",{sessionId:t,action:e})];case 1:return[2,r.sent().json()]}})})()}},{key:"updateElement",value:function e(e,t){var n=this;return o(function(){return M(this,function(r){switch(r.label){case 0:return[4,n.put("/project/element",{sessionId:t,element:e})];case 1:return[2,r.sent().json()]}})})()}},{key:"deleteElement",value:function e(e,t){var n=this;return o(function(){return M(this,function(r){switch(r.label){case 0:return[4,n.delete("/project/element",{sessionId:t,element:e})];case 1:return[2,r.sent().json()]}})})()}},{key:"getElementUrl",value:function e(e,t){var n="?session_id=".concat(t);return this.buildEndpoint("/project/file/".concat(e).concat(n))}},{key:"getLogoEndpoint",value:function e(e){return this.buildEndpoint("/logo?theme=".concat(e))}},{key:"getOAuthEndpoint",value:function e(e){return this.buildEndpoint("/auth/oauth/".concat(e))}}]);return t}(e6);var e5=undefined,e7=U.createContext(new e8("http://localhost:8000","webapp"));var e9=function(){var e=U.useContext(e7),t=O.useRecoilValue(eg),n=O.useRecoilValue(eb),r=O.useRecoilValue(ev),a=O.useResetRecoilState(ex),o=O.useResetRecoilState(ev),s=O.useResetRecoilState(eI),i=O.useSetRecoilState(eT),u=O.useSetRecoilState(ew),c=O.useSetRecoilState(em),l=O.useSetRecoilState(eP),f=O.useSetRecoilState(eD),d=O.useSetRecoilState(ey),h=O.useSetRecoilState(ek),p=O.useSetRecoilState(ed),v=O.useSetRecoilState(eU),g=O.useSetRecoilState(eL),y=U.useCallback(function(){t===null||t===void 0?void 0:t.socket.emit("clear_session"),t===null||t===void 0?void 0:t.socket.disconnect(),p(undefined),o(),i(undefined),c([]),l([]),f([]),d([]),h(0),a(),s(),v(undefined),g(undefined)},[t]),m=U.useCallback(function(e){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];e.id||(e.id=B.v4()),e.createdAt||(e.createdAt=new Date().toISOString()),c(function(t){return eW(t,e)}),t===null||t===void 0?void 0:t.socket.emit("client_message",{message:e,fileReferences:n})},[t===null||t===void 0?void 0:t.socket]),k=U.useCallback(function(e){t===null||t===void 0?void 0:t.socket.emit("edit_message",{message:e})},[t===null||t===void 0?void 0:t.socket]),w=U.useCallback(function(e){t===null||t===void 0?void 0:t.socket.emit("window_message",e)},[t===null||t===void 0?void 0:t.socket]),b=U.useCallback(function(){t===null||t===void 0?void 0:t.socket.emit("audio_start")},[t===null||t===void 0?void 0:t.socket]),S=U.useCallback(function(e,n,r,a){t===null||t===void 0?void 0:t.socket.emit("audio_chunk",{isStart:e,mimeType:n,elapsedTime:r,data:a})},[t===null||t===void 0?void 0:t.socket]),A=U.useCallback(function(){t===null||t===void 0?void 0:t.socket.emit("audio_end")},[t===null||t===void 0?void 0:t.socket]),R=U.useCallback(function(e){n&&(n.parentId&&(e.parentId=n.parentId),c(function(t){return eW(t,e)}),n.callback(e))},[n]),_=U.useCallback(function(e){t===null||t===void 0?void 0:t.socket.emit("chat_settings_change",e)},[t===null||t===void 0?void 0:t.socket]),C=U.useCallback(function(){c(function(e){return e.map(function(e){return e.streaming=false,e})}),u(false),t===null||t===void 0?void 0:t.socket.emit("stop")},[t===null||t===void 0?void 0:t.socket]);return{uploadFile:U.useCallback(function(t,n){return e.uploadFile(t,n,r)},[r]),clear:y,replyMessage:R,sendMessage:m,editMessage:k,windowMessage:w,startAudioStream:b,sendAudioChunk:S,endAudioStream:A,stopTask:C,setIdToResume:p,updateChatSettings:_}};var te=function(){var e=O.useRecoilValue(em),t=O.useRecoilValue(eT);return{threadId:O.useRecoilValue(eL),messages:e,firstInteraction:t}};var tt=function(){var e=U.useContext(e7),t=O.useRecoilValue(ev),n=x(O.useRecoilState(eg),2),r=n[0],a=n[1],s=O.useSetRecoilState(e_),i=O.useSetRecoilState(eR),u=O.useResetRecoilState(eI),c=O.useSetRecoilState(eT),l=O.useSetRecoilState(ew),f=O.useRecoilValue(eA),d=O.useRecoilValue(eS),h=O.useSetRecoilState(em),p=O.useSetRecoilState(eb),v=O.useSetRecoilState(eC),g=O.useSetRecoilState(eP),y=O.useSetRecoilState(eD),m=O.useSetRecoilState(ey),k=O.useSetRecoilState(ex),w=O.useSetRecoilState(ek),b=x(O.useRecoilState(eh),2),A=b[0],_=b[1],C=O.useRecoilValue(ed),I=x(O.useRecoilState(eL),2),P=I[0],D=I[1];U.useEffect(function(){(r===null||r===void 0?void 0:r.socket)&&(r.socket.auth.threadId=P||"")},[P]);var T=U.useCallback(function(n){var r=n.transports,b=n.userEnv;var x=new URL(e.httpEndpoint),I=x.protocol,P=x.host,T=x.pathname,O="".concat(I,"//").concat(P),j=T&&T!=="/"?"".concat(T,"/ws/socket.io"):"/ws/socket.io",B=W.default(O,{path:j,withCredentials:true,transports:r,auth:{clientType:e.type,sessionId:t,threadId:C||"",userEnv:JSON.stringify(b),chatProfile:A?encodeURIComponent(A):""}});a(function(e){var t,n;return e===null||e===void 0?void 0:(t=e.socket)===null||t===void 0?void 0:t.removeAllListeners(),e===null||e===void 0?void 0:(n=e.socket)===null||n===void 0?void 0:n.close(),{socket:B}}),B.on("connect",function(){B.emit("connection_successful"),a(function(e){return R(S({},e),{error:false})})}),B.on("connect_error",function(e){a(function(e){return R(S({},e),{error:true})})}),B.on("task_start",function(){l(true)}),B.on("task_end",function(){l(false)}),B.on("reload",function(){B.emit("clear_session"),window.location.reload()}),B.on("audio_connection",/*#__PURE__*/function(){var e=o(function(e){var t,n,r;return M(this,function(a){switch(a.label){case 0:if(!(e==="on"))return[3,4];t=true,n=Date.now(),r="pcm16";return[4,d.begin()];case 1:a.sent();return[4,f.connect()];case 2:a.sent();return[4,d.record(/*#__PURE__*/function(){var e=o(function(e){var a;return M(this,function(o){a=Date.now()-n;B.emit("audio_chunk",{isStart:t,mimeType:r,elapsedTime:a,data:e.mono}),t=false;return[2]})});return function(t){return e.apply(this,arguments)}}())];case 3:a.sent(),f.onStop=function(){return s(false)};return[3,7];case 4:return[4,d.end()];case 5:a.sent();return[4,f.interrupt()];case 6:a.sent();a.label=7;case 7:i(e);return[2]}})});return function(t){return e.apply(this,arguments)}}()),B.on("audio_chunk",function(e){f.add16BitPCM(e.data,e.track),s(true)}),B.on("audio_interrupt",function(){f.interrupt()}),B.on("resume_thread",function(e){var t,n;var r=[];var a=true,o=false,s=undefined;try{for(var i=e.steps[Symbol.iterator](),u;!(a=(u=i.next()).done);a=true){var c=u.value;r=eW(r,c)}}catch(e){o=true;s=e}finally{try{if(!a&&i.return!=null){i.return()}}finally{if(o){throw s}}}((t=e.metadata)===null||t===void 0?void 0:t.chat_profile)&&_((n=e.metadata)===null||n===void 0?void 0:n.chat_profile),h(r);var l=e.elements||[];y(l.filter(function(e){return e.type==="tasklist"})),g(l.filter(function(e){return["avatar","tasklist"].indexOf(e.type)===-1}))}),B.on("new_message",function(e){h(function(t){return eW(t,e)})}),B.on("first_interaction",function(e){c(e.interaction),D(e.thread_id)}),B.on("update_message",function(e){h(function(t){return e$(t,e.id,e)})}),B.on("delete_message",function(e){h(function(t){return eJ(t,e.id)})}),B.on("stream_start",function(e){h(function(t){return eW(t,e)})}),B.on("stream_token",function(e){var t=e.id,n=e.token,r=e.isSequence,a=e.isInput;h(function(e){return eY(e,t,n,r,a)})}),B.on("ask",function(e,t){var n=e.msg,r=e.spec;p({spec:r,callback:t,parentId:n.parentId}),h(function(e){return eW(e,n)}),l(false)}),B.on("ask_timeout",function(){p(undefined),l(false)}),B.on("clear_ask",function(){p(undefined)}),B.on("call_fn",function(e,t){var n=e.name,r=e.args;v({name:n,args:r,callback:t})}),B.on("clear_call_fn",function(){v(undefined)}),B.on("call_fn_timeout",function(){v(undefined)}),B.on("chat_settings",function(e){k(e),u()}),B.on("element",function(n){!n.url&&n.chainlitKey&&(n.url=e.getElementUrl(n.chainlitKey,t)),n.type==="tasklist"?y(function(e){var t=e.findIndex(function(e){return e.id===n.id});return t===-1?E(e).concat([n]):E(e.slice(0,t)).concat([n],E(e.slice(t+1)))}):g(function(e){var t=e.findIndex(function(e){return e.id===n.id});return t===-1?E(e).concat([n]):E(e.slice(0,t)).concat([n],E(e.slice(t+1)))})}),B.on("remove_element",function(e){g(function(t){return t.filter(function(t){return t.id!==e.id})}),y(function(t){return t.filter(function(t){return t.id!==e.id})})}),B.on("action",function(e){m(function(t){return E(t).concat([e])})}),B.on("remove_action",function(e){m(function(t){var n=t.findIndex(function(t){return t.id===e.id});return n===-1?t:E(t.slice(0,n)).concat(E(t.slice(n+1)))})}),B.on("token_usage",function(e){w(function(t){return t+e})}),B.on("window_message",function(e){window.parent&&window.parent.postMessage(e,"*")})},[a,t,A]),B=U.useCallback(j.debounce(T,200),[T]),L=U.useCallback(function(){(r===null||r===void 0?void 0:r.socket)&&(r.socket.removeAllListeners(),r.socket.close())},[r]);return{connect:B,disconnect:L,session:r,sessionId:t,chatProfile:A,idToResume:C,setChatProfile:_}};var tn=function(){var e=x(O.useRecoilState(eR),2),t=e[0],n=e[1],r=O.useRecoilValue(eS),a=O.useRecoilValue(eA),s=O.useRecoilValue(e_),i=e9(),u=i.startAudioStream,c=i.endAudioStream,l=U.useCallback(/*#__PURE__*/o(function(){return M(this,function(e){switch(e.label){case 0:n("connecting");return[4,u()];case 1:e.sent();return[2]}})}),[u]),f=U.useCallback(/*#__PURE__*/o(function(){return M(this,function(e){switch(e.label){case 0:n("off");return[4,r.end()];case 1:e.sent();return[4,a.interrupt()];case 2:e.sent();return[4,c()];case 3:e.sent();return[2]}})}),[c,r,a]);return{startConversation:l,endConversation:f,audioConnection:t,isAiSpeaking:s,wavRecorder:r,wavStreamPlayer:a}};var tr=function(){var e=x(O.useRecoilState(eO),2),t=e[0],n=e[1],r=e3(),a=r.isAuthenticated,o=navigator.language||"en-US",s=eZ(!t&&a?"/project/settings?language=".concat(o):null),i=s.data,u=s.error,c=s.isLoading;return U.useEffect(function(){i&&n(i)},[i,n]),{config:t,error:u,isLoading:c,language:o}};var ta=new WeakMap,to=function(e,t){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:false,r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:false;var a,o,s;if(r&&(o=t.toString(),s=n.toString(),a=ta.has(e)?ta.get(e):{},ta.set(e,a),a[o]=a[o]||{},a[o][s]))return a[o][s];var i=e.length,u=new Array(t);if(t<=i){u.fill(0);var c=new Array(t).fill(0);for(var l=0;l<i;l++){var f=Math.floor(l*(t/i));n?u[f]=Math.max(u[f],Math.abs(e[l])):u[f]+=Math.abs(e[l]),c[f]++}if(!n)for(var d=0;d<u.length;d++)u[d]=u[d]/c[d]}else for(var h=0;h<t;h++){var p=h*(i-1)/(t-1),v=Math.floor(p),g=Math.ceil(p),y=p-v;g>=i?u[h]=e[i-1]:u[h]=e[v]*(1-y)+e[g]*y}return r&&(a[o][s]=u),u},ts={drawBars:function(e,t,n,r,a){var o=arguments.length>5&&arguments[5]!==void 0?arguments[5]:0,s=arguments.length>6&&arguments[6]!==void 0?arguments[6]:0,i=arguments.length>7&&arguments[7]!==void 0?arguments[7]:0,u=arguments.length>8&&arguments[8]!==void 0?arguments[8]:false;o=Math.floor(Math.min(o,(n-i)/(Math.max(s,1)+i))),o||(o=Math.floor((n-i)/(Math.max(s,1)+i))),s||(s=(n-i)/o-i);var c=to(t,o,true);for(var l=0;l<o;l++){var f=Math.abs(c[l]),d=Math.max(1,f*r),h=i+l*(s+i),p=u?(r-d)/2:r-d,v=Math.min(s/2,d/2);e.fillStyle=a,e.beginPath(),e.moveTo(h+v,p),e.lineTo(h+s-v,p),e.arcTo(h+s,p,h+s,p+v,v),e.lineTo(h+s,p+d-v),e.arcTo(h+s,p+d,h+s-v,p+d,v),e.lineTo(h+v,p+d),e.arcTo(h,p+d,h,p+d-v,v),e.lineTo(h,p+v),e.arcTo(h,p,h+v,p,v),e.closePath(),e.fill()}}};Object.defineProperty(exports,"Socket",{enumerable:true,get:function e(){return F.Socket}});exports.APIBase=e6;exports.ChainlitAPI=e8;exports.ChainlitContext=e7;exports.ClientError=e4;exports.WavRenderer=ts;exports.actionState=ey;exports.addMessage=eW;exports.addMessageToParent=ez;exports.askUserState=eb;exports.audioConnectionState=eR;exports.authState=ej;exports.callFnState=eC;exports.chatProfileState=eh;exports.chatSettingsDefaultValueSelector=eE;exports.chatSettingsInputsState=ex;exports.chatSettingsValueState=eI;exports.configState=eO;exports.currentThreadIdState=eL;exports.defaultChainlitContext=e5;exports.deleteMessageById=eJ;exports.elementState=eP;exports.fetcher=eX;exports.firstUserInteraction=eT;exports.hasMessageById=eH;exports.isAiSpeakingState=e_;exports.isLastMessage=eq;exports.loadingState=ew;exports.messagesState=em;exports.nestMessages=eV;exports.sessionIdState=ev;exports.sessionState=eg;exports.sideViewState=eU;exports.tasklistState=eD;exports.threadHistoryState=eB;exports.threadIdToResumeState=ed;exports.tokenCountState=ek;exports.updateMessageById=e$;exports.updateMessageContentById=eY;exports.useApi=eZ;exports.useAudio=tn;exports.useAuth=e3;exports.useChatData=eF;exports.useChatInteract=e9;exports.useChatMessages=te;exports.useChatSession=tt;exports.useConfig=tr;exports.userState=eM;exports.wavRecorderState=eS;exports.wavStreamPlayerState=eA;//# sourceMappingURL=index.js.map